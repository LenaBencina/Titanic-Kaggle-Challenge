---
title: "Titanic survival prediction"
author: "Lena Bencina"
date: "12.1.2019"
output: html_document
---

<!-- include = FALSE prevents code and results from appearing in the finished file. R Markdown still runs the code in the chunk, and the results can be used by other chunks. -->
<!-- echo = FALSE prevents code, but not the results from appearing in the finished file. This is a useful way to embed figures. -->
<!-- message = FALSE prevents messages that are generated by code from appearing in the finished file. -->
<!-- warning = FALSE prevents warnings that are generated by code from appearing in the finished. -->
<!-- fig.cap = "..." adds a caption to graphical results. -->

```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = '../')
knitr::opts_chunk$set(echo = TRUE, fig.align="center")
```

```{r, include = FALSE}
# import all the code
source('Rscripts/AdditionalFunctions.R')
source('Rscripts/Preprocessing.R')
source('Rscripts/ImputeAge.R')
source('Rscripts/Train.R')
source('Rscripts/PreprocessingTestData.R')
source('Rscripts/Predict.R')
library(knitr)
library(kableExtra)
```
<br>

## Importing data
We start by importing the training dataset. 
```{r, echo = FALSE, results = 'asis'}
kable(train.data.original[1:10,]) %>%  kable_styling(bootstrap_options = "striped", full_width = F)
```

We can see that our dataset has `r nrow(train.data.original)` observations and `r ncol(train.data.original)` features. 

We are dealing with categorical and numeric features, so we need to take care the **type conversion**. Features *`r factor.cols.train`* will be converted to factors and the rest will be left as it is.

```{r, echo = FALSE, results = 'asis'}
kable(train.data.original %>% summarise_all(class)) %>%  kable_styling(bootstrap_options = "striped", full_width = F)
```

Next, we need to check the **missing data**. let's compute the % of missing data and visualize it.

```{r, echo = FALSE}
kable(round(sort(sapply(train.data.original, function(x){sum(is.na(x))}))/n.train*100, 1), col.names = c('% of missing data')) %>%  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

```{r, echo = FALSE, warning = FALSE}
missmap(train.data.original, main = 'Missing values in train data', legend = FALSE, col = c('#81C853', '#275176'))
```

Three features have some missing data:

1. **CABIN**: It doesn't make sense to impute the data where there is only 23% values. We will remove the Cabin feature due to high amount of missing data.

2. **EMBARKED**: We don't have this information for only for two passengers. We will remove these two observations for now and not waste time with imputations here. If there will be time we will get back to it and impute it with knn or some other classification algorithm.

3. **AGE**: Intuitive guess would be that age is an important feature for survival prediction. We will make an imputation model to predict the missing age, but first let's analyse all the features.

<br>
<br>

## Feature analysis

Check the overall distribution of dependent variable:
```{r, echo = FALSE}
kable(table(train.data.original$Survived), col.names = c('Survived', 'Freq'))%>%  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

There is enough observations in each classes, so we do not need to worry about that. Next, we will analyse each feature.

<br>
<br>

### 1.NAME

Name is a text feature and thus it is not useful for further analysis in this form. One way to use it would be with additional text mining analysis, however, following intuition, a passenger's name is not really relevant for predicting the survival. On the other hand, we can see that each name includes the name title, such as Mrs., Ms., Miss, etc. We will extract it and make an additional feature (Name.title) from it. 

This is the distribution of original name titles:

```{r, echo = FALSE}
kable(rev(sort(table(name.title.original))), col.names = c('Original name title', 'Freq'))%>%  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

A lot of categories includes only one observation which can lead to poor predictions. let's try to combine it with the following mapping.

```{r, echo = FALSE}
kable(title.conv, col.names = c('Mapped to'))%>%  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

The distribution is now the following.

```{r, echo = FALSE}
kable(rev(sort(table(train.data$Name.title))), col.names = c('New name title', 'Freq'))%>%  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

The distribution of new feature by survival is presented in the next plot.

```{r, echo = FALSE}
plot.survival.dist.name.title
```

<br>
<br>

### 2. SEX

Next feature is Sex. Let's see the distribution by survival.

```{r, echo = FALSE}
plot.survival.dist.sex
```

It seems like Sex is correlated with survival (more women survived and more men died).

<br>
<br>

### 3. PCLASS

Pclass feature represents the ticket class of a passenger, i.e. a proxy for socio-economic status, which can be 1, 2, or 3. We can include it as ordered factor or as an integer. Because the integer will incorporate the distance between classes, we will include it as an integer.

Distribution of Pclass feature by survival is the following.

```{r, echo = FALSE}
plot.survival.dist.pclass
```

Pclass also looks correlated with the independent feature. In the 1st class more people survived and in the 3rd class more people died.

<br>
<br>

### 4. TICKET

Ticket feature has `r ticket.classes.length` clasees. Most of them includes only one or two observations. The following table represents the number of classes with *n* observations.

```{r, echo = FALSE}
kable(table(table(train.data.original$Ticket)), col.names = c('Number of observations per class', 'Freq')) %>%  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

We can see that 547 tickets are unique, which is more than half of the passengers. This information doesn't seem irrelevant. From this we can assume that new ticket classes will appear within the test set. For now we will delete the feature and later on we can try to parse some information such as ticket prefix from it and create a new feature.

### 5. FARE

Distribution of numerical feature Fare is distributed by survival as following.

```{r, echo = FALSE, warning = FALSE}
plot.fare.by.survived
```

We can see that survived had higher fares. For example, between people with fares less than (or equal) 50 number of died is aprox. two times the number of survived and vice versa for people with fares higher than 50.

```{r, echo = FALSE}
kable(fare.matrix.50) %>%  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```



### 6. EMBARKED

Embarked feature tells us the passenger's port of embarkation. 

```{r, echo = FALSE, warning = FALSE}
plot.survival.dist.travel.alone
```

Is this info relevant? Let's leave it for now and let the algorithms decide.

### 7. SIBSP & PARCH

A bit less intuitive features are features Sibsp and Parch, where SibSp is the number of siblings/spouses aboard and Parch is the number of parents/children aboard. These features don't make much sense. A better way to represent this information is to use it for calculation of family size for each passenger.

The equation used to create family size feature is

```{r, echo = FALSE}
print('Family.size = Sibsp + Parch + 1')
```

Another information which could be relevant is if the passenger was traveling alone, i.e. where family size is 0.

```{r, echo = FALSE}
plot.survival.dist.travel.alone
```

More people traveling alone died than survived.

## Age imputation

...































